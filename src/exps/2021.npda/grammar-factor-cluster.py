import numpy as np

factor_distance_str = """sum-err	log-sum-err	log_train_grammar_size_size	log_train_rule_stats_mean	log_train_rule_stats_std	log_train_rule_stats_median	log_train_heights_stat_mean	log_train_heights_stat_std	log_train_heights_stat_median	log_train_tree_rule_num_stat_mean	log_train_tree_rule_num_stat_std	log_train_tree_rule_num_stat_median	log_train_distinct_rule_num_stat_mean	log_train_distinct_rule_num_stat_std	log_train_distinct_rule_num_stat_median	log_dev_heights_stat_mean	log_dev_heights_stat_std	log_dev_heights_stat_median	log_dev_tree_rule_num_stat_mean	log_dev_tree_rule_num_stat_std	log_dev_tree_rule_num_stat_median	log_dev_distinct_rule_num_stat_mean	log_dev_distinct_rule_num_stat_std	log_dev_distinct_rule_num_stat_median	train_grammar_size_size	train_rule_stats_mean	train_rule_stats_std	train_rule_stats_median	train_heights_stat_mean	train_heights_stat_std	train_heights_stat_median	train_tree_rule_num_stat_mean	train_tree_rule_num_stat_std	train_tree_rule_num_stat_median	train_distinct_rule_num_stat_mean	train_distinct_rule_num_stat_std	train_distinct_rule_num_stat_median	dev_heights_stat_mean	dev_heights_stat_std	dev_heights_stat_median	dev_tree_rule_num_stat_mean	dev_tree_rule_num_stat_std	dev_tree_rule_num_stat_median	dev_distinct_rule_num_stat_mean	dev_distinct_rule_num_stat_std	dev_distinct_rule_num_stat_median	base_dev_ll_rec_mean_likelihood	base_dev_ll_rec_recall	full_dev_ll_rec_mean_likelihood	kl_stats_p1_coverage	kl_stats_p2_coverage	kl_stats_union_coverage	kl_stats_base_p_q	kl_stats_base_q_p	kl_stats_smooth_p_q	kl_stats_smooth_q_p
sum-err	1					0.538173918																																																		
log-sum-err	0.999986392	1				0.537393856																																																		
log_train_grammar_size_size	-0.013950302	-0.015853686	1			-0.040544278																																																		
log_train_rule_stats_mean	0.379406367	0.380203934	-0.366975536	1		0.882689087																																																		
log_train_rule_stats_std	0.309283597	0.31019815	-0.529449536	0.973800541	1	0.790639605																																																		
log_train_rule_stats_median	0.538173918	0.537393856	-0.040544278	0.882689087	0.790639605	1																																																		
log_train_heights_stat_mean	0.325656513	0.325674445	0.24751171	0.711949831	0.565411787	0.833580904	1																																																	
log_train_heights_stat_std	0.176411712	0.174157313	0.610688218	0.27536319	0.142762556	0.480038529	0.611555943	1																																																
log_train_heights_stat_median	0.301031933	0.300976003	0.242634812	0.712808558	0.565193652	0.831896361	0.996073478	0.604772745	1																																															
log_train_tree_rule_num_stat_mean	0.437074239	0.437543683	-0.083191152	0.846604509	0.773120989	0.862519186	0.900451629	0.493310718	0.885967323	1																																														
log_train_tree_rule_num_stat_std	0.501321038	0.501394542	-0.062259873	0.83084111	0.767555577	0.850407538	0.83591614	0.556528664	0.818875721	0.974541667	1																																													
log_train_tree_rule_num_stat_median	0.413199525	0.413708515	-0.117348491	0.85080637	0.784884852	0.857016059	0.892005302	0.469014749	0.877268794	0.997904488	0.963458211	1																																												
log_train_distinct_rule_num_stat_mean	0.472626987	0.473024607	0.247210377	0.664268921	0.509058533	0.803797919	0.964398308	0.609800968	0.951620888	0.906231397	0.856719276	0.892563582	1																																											
log_train_distinct_rule_num_stat_std	0.425320411	0.424386725	0.636511985	-0.154728862	-0.320777143	0.12238585	0.275002481	0.665685596	0.261886967	0.124023175	0.185360198	0.085361885	0.42703766	1																																										
log_train_distinct_rule_num_stat_median	0.406444302	0.407026742	0.205206008	0.677802649	0.534113283	0.790289958	0.968409721	0.569870151	0.956370218	0.920187203	0.854646603	0.911984003	0.992623279	0.343166818	1																																									
log_dev_heights_stat_mean	0.325192725	0.325185632	0.261491425	0.693504652	0.543327841	0.822961653	0.998721842	0.606623205	0.995343105	0.893142302	0.828388682	0.883532883	0.966127351	0.28904031	0.969065261	1																																								
log_dev_heights_stat_std	0.125055444	0.12278354	0.650272117	0.105944159	-0.022038564	0.329451106	0.547932813	0.957797126	0.534457338	0.431466602	0.48306915	0.410065885	0.572645816	0.701616156	0.538457828	0.546916391	1																																							
log_dev_heights_stat_median	0.337877524	0.337831928	0.248911666	0.691247727	0.53887107	0.823978793	0.99410197	0.605779833	0.993268755	0.885023996	0.822944386	0.874474118	0.962062162	0.311932549	0.959071122	0.996560976	0.544417188	1																																						
log_dev_tree_rule_num_stat_mean	0.430975946	0.431434566	-0.079134802	0.838603576	0.765202294	0.854898829	0.901231133	0.490280835	0.886098729	0.999555903	0.972775967	0.99767746	0.90623162	0.119630772	0.921519986	0.894579243	0.432631462	0.88565797	1																																					
log_dev_tree_rule_num_stat_std	0.494243216	0.494204846	-0.009823217	0.743166167	0.679640778	0.794303108	0.819426512	0.566849541	0.798119231	0.961396945	0.987095787	0.950010432	0.858687967	0.23248743	0.857588952	0.814280187	0.531383209	0.806821159	0.960902584	1																																				
log_dev_tree_rule_num_stat_median	0.404781127	0.405328475	-0.113934931	0.84026786	0.774202946	0.844722942	0.88988638	0.457229034	0.875706545	0.997354801	0.964567959	0.998004839	0.891968683	0.080005248	0.912975233	0.883530228	0.400605477	0.873617248	0.998280435	0.952583906	1																																			
log_dev_distinct_rule_num_stat_mean	0.46068803	0.461106762	0.244442022	0.648384855	0.495898883	0.787146777	0.962748146	0.595340615	0.948338773	0.907381774	0.854249044	0.894880083	0.998368889	0.413423669	0.994449467	0.965862477	0.567169678	0.9605661	0.908851732	0.860443026	0.8963215	1																																		
log_dev_distinct_rule_num_stat_std	0.409062065	0.407929168	0.710287102	-0.208985696	-0.378669914	0.098010133	0.29030485	0.667464039	0.272523384	0.124199088	0.177859306	0.086212521	0.44031442	0.98650235	0.362822332	0.306032514	0.732814811	0.321355415	0.122536052	0.241840027	0.082877525	0.431883837	1																																	
log_dev_distinct_rule_num_stat_median	0.433634781	0.434287878	0.177640175	0.67263137	0.533041905	0.781902271	0.958426999	0.545324524	0.944302828	0.924513565	0.859763301	0.916867221	0.990909113	0.343660368	0.997588833	0.960618141	0.519670158	0.952352866	0.926529599	0.865489875	0.918907526	0.995005498	0.363164127	1																																
train_grammar_size_size	0.010505999	0.008531658	0.997719501	-0.382876191	-0.542654011	-0.048902752	0.234683353	0.59174138	0.229378274	-0.091923809	-0.069001918	-0.126169342	0.235831372	0.627824674	0.192803352	0.249169619	0.636595448	0.236577771	-0.086909784	-0.014448884	-0.121919024	0.234475942	0.705254471	0.167370941	1																															
train_rule_stats_mean	0.317962307	0.317955928	-0.187299534	0.873660245	0.850781168	0.797474579	0.668106861	0.318853418	0.658359633	0.768983999	0.790359117	0.76419486	0.581189637	-0.203715257	0.595292481	0.65584625	0.153973992	0.643906268	0.76931912	0.706573653	0.770460382	0.577644056	-0.224487658	0.590181947	-0.194259193	1																														
train_rule_stats_std	0.303012504	0.303180773	-0.323023698	0.863291207	0.873376931	0.736724384	0.569474733	0.183382162	0.562761806	0.720037682	0.7456359	0.719183452	0.479353989	-0.332705353	0.499257794	0.55589186	0.027866973	0.545535074	0.720902468	0.659471578	0.726531457	0.477384461	-0.355395071	0.498817298	-0.323663213	0.981978967	1																													
train_rule_stats_median	0.449054723	0.448462431	0.054721258	0.826048476	0.756307346	0.903112029	0.808923414	0.519274329	0.789860867	0.85346407	0.863781153	0.845447021	0.756672905	0.039020032	0.75950679	0.796701784	0.373482148	0.777882215	0.851657971	0.815308249	0.843752089	0.751060253	0.041824205	0.750160256	0.046874053	0.911620748	0.840661634	1																												
train_heights_stat_mean	0.340242223	0.340029508	0.258761836	0.725574174	0.602822329	0.842010216	0.971129968	0.66979163	0.95991753	0.914775764	0.87256673	0.90877442	0.931939485	0.2399855	0.940867272	0.964316692	0.594747957	0.949955403	0.914937536	0.859837865	0.903682836	0.930646818	0.262436937	0.929439265	0.246948852	0.71511209	0.61569839	0.877448853	1																											
train_heights_stat_std	0.193309836	0.191247364	0.541208046	0.364668259	0.24792648	0.541034818	0.655909897	0.98860753	0.646324312	0.581903542	0.648083871	0.559775683	0.648213688	0.587814021	0.616548332	0.649134194	0.937146525	0.6444441	0.578938344	0.657619214	0.549415649	0.635791186	0.591728613	0.594221759	0.522723464	0.412934638	0.28660808	0.602831215	0.731801408	1																										
train_heights_stat_median	0.316849554	0.316592197	0.249740543	0.730930635	0.60697344	0.843323607	0.976384739	0.666992314	0.971087152	0.913246344	0.867028716	0.907670848	0.931115476	0.231561663	0.940914886	0.970438145	0.591608149	0.958850866	0.913080825	0.852333907	0.902590761	0.928995232	0.251247135	0.928510907	0.237495676	0.702975929	0.606962702	0.857317877	0.996926897	0.727289677	1																									
train_tree_rule_num_stat_mean	0.373269884	0.373025204	0.077834792	0.748816744	0.697833311	0.804870214	0.827565509	0.570486649	0.809735138	0.914376363	0.926603951	0.908712744	0.79246822	0.066386595	0.806034835	0.816028281	0.488761692	0.796943815	0.91386019	0.922828642	0.907877789	0.793969137	0.08800865	0.802062833	0.074222405	0.782947881	0.726907923	0.905828849	0.916503715	0.674557376	0.905532782	1																								
train_tree_rule_num_stat_std	0.395264562	0.394902546	0.080438958	0.744256888	0.698568727	0.789383086	0.786381816	0.59773459	0.767013809	0.891660929	0.930345036	0.881253873	0.757416474	0.093340444	0.763434961	0.774880918	0.504301466	0.757214455	0.890736568	0.921287672	0.882357892	0.757224196	0.107151848	0.759879716	0.076412361	0.809153804	0.754124239	0.911811815	0.885077325	0.70176633	0.870890086	0.991254232	1																							
train_tree_rule_num_stat_median	0.366182105	0.365932854	0.067737794	0.748603309	0.699653527	0.804254377	0.827826876	0.564187948	0.810396351	0.916428416	0.924593287	0.912402997	0.79173458	0.056678552	0.807081581	0.816007109	0.486067085	0.796995758	0.915915972	0.922316761	0.910700552	0.793616508	0.079335651	0.803411654	0.064372717	0.773817403	0.719613087	0.898753605	0.916759037	0.668884971	0.906867806	0.999480762	0.987582883	1																						
train_distinct_rule_num_stat_mean	0.442917927	0.442912119	0.298162416	0.655646398	0.520260612	0.811991934	0.95343623	0.661745999	0.937370296	0.90504926	0.861623543	0.896600376	0.964112329	0.356280147	0.966086462	0.948951534	0.61582112	0.933796575	0.904934522	0.869178577	0.891293408	0.963267841	0.385222615	0.959546953	0.290403581	0.605312814	0.502245835	0.818004031	0.976760986	0.715549842	0.970716774	0.883143387	0.845762182	0.884393065	1																					
train_distinct_rule_num_stat_std	0.458382926	0.457227029	0.628109802	-0.184130603	-0.343077606	0.089096294	0.212935495	0.632247111	0.202867399	0.083648101	0.161704607	0.041793956	0.377029483	0.984098987	0.291483906	0.228325425	0.674839459	0.248189994	0.080242083	0.209686056	0.039902288	0.363263995	0.976246217	0.293088664	0.625219885	-0.220908816	-0.332894808	-0.000904782	0.178899923	0.553078379	0.172473188	0.023305903	0.058214717	0.012800737	0.303297065	1																				
train_distinct_rule_num_stat_median	0.405104974	0.405155882	0.270240196	0.662148135	0.535748563	0.803994563	0.951386757	0.639118486	0.935433373	0.911362568	0.860324208	0.906344813	0.953696532	0.302999873	0.963730297	0.945854786	0.597022529	0.927809199	0.911889729	0.868988519	0.90139504	0.954765682	0.335767727	0.956933152	0.262245061	0.614875922	0.516383263	0.820974868	0.979613879	0.698437378	0.97368311	0.893360375	0.852125665	0.89574705	0.997543366	0.248424174	1																			
dev_heights_stat_mean	0.341890566	0.341675414	0.264711791	0.719941203	0.594153191	0.840495561	0.975293801	0.665835039	0.964897576	0.91439643	0.870316168	0.907930244	0.937814886	0.24731531	0.946355198	0.969930415	0.593257614	0.956259181	0.914922129	0.85844015	0.903804087	0.937150108	0.270748571	0.935654153	0.253291545	0.707408597	0.60759567	0.870200656	0.999436629	0.726534897	0.997690326	0.910456238	0.877740465	0.910821743	0.978158275	0.187404324	0.980347755	1																		
dev_heights_stat_std	0.139501009	0.137376251	0.592823546	0.18110886	0.064065195	0.38180871	0.591432606	0.953804557	0.580069831	0.506070375	0.557722042	0.486809966	0.609881107	0.647128762	0.58084082	0.588646079	0.988785594	0.586244407	0.506286368	0.6064431	0.476294147	0.604537635	0.677504159	0.563986659	0.580197754	0.205968973	0.09135409	0.417826658	0.647449599	0.950479247	0.647833275	0.570590201	0.582130097	0.569946408	0.664588558	0.621351011	0.649421937	0.645412483	1																	
dev_heights_stat_median	0.334917924	0.334691846	0.24954447	0.727462457	0.601006547	0.843533444	0.980278475	0.668592951	0.972642126	0.918698764	0.873993672	0.912408959	0.941112727	0.253372547	0.947904534	0.975484705	0.597327586	0.965915909	0.918815059	0.860952941	0.90757248	0.939751817	0.27244139	0.937770001	0.237648842	0.700313285	0.603209854	0.855069687	0.996754281	0.727859445	0.998793286	0.903055497	0.869431656	0.904162765	0.973659379	0.192495928	0.974934949	0.998072177	0.652122258	1																
dev_tree_rule_num_stat_mean	0.373420865	0.373173908	0.076903172	0.749345464	0.698404004	0.80469861	0.828105557	0.567760527	0.810197716	0.914971896	0.927019411	0.909293049	0.792437248	0.062499545	0.806429162	0.816764545	0.486357118	0.797452849	0.91473265	0.922821583	0.908971186	0.79432045	0.084727513	0.802650155	0.073624851	0.787899917	0.73245853	0.907977422	0.916575863	0.67199208	0.905432702	0.999912869	0.991494644	0.999263632	0.882517638	0.020331293	0.892946055	0.910602934	0.567723211	0.902993331	1															
dev_tree_rule_num_stat_std	0.393002801	0.392605685	0.118090271	0.662145703	0.617351899	0.736279056	0.768314733	0.598764137	0.749146179	0.876713795	0.911077619	0.867142736	0.758857565	0.141837092	0.764708231	0.758430892	0.541967532	0.741120313	0.875627276	0.928155558	0.866464811	0.76059614	0.168340158	0.763565927	0.117084766	0.683397904	0.630497497	0.832428821	0.868596763	0.70185278	0.858292739	0.982881034	0.979062801	0.982929791	0.85637779	0.107191783	0.862840735	0.863156171	0.628683572	0.857356214	0.981591215	1														
dev_tree_rule_num_stat_median	0.366857764	0.36662809	0.056450824	0.754529204	0.707763135	0.804803044	0.821584556	0.5487864	0.803803095	0.915025801	0.926600061	0.909968027	0.783824333	0.039255081	0.799583334	0.810281103	0.466413238	0.790691454	0.914975236	0.9216151	0.910541361	0.7862846	0.061265771	0.796226436	0.053422013	0.797178343	0.745001873	0.910348818	0.909658754	0.655319093	0.898329515	0.999228854	0.99095807	0.998574929	0.873228265	-0.002321799	0.884816335	0.903566823	0.548570017	0.895697987	0.99950887	0.978839032	1													
dev_distinct_rule_num_stat_mean	0.439525017	0.439524911	0.294615285	0.646150656	0.513223574	0.802193701	0.950839985	0.651364624	0.934086183	0.905940809	0.860821816	0.898194225	0.961850355	0.345991925	0.965947448	0.946961067	0.611260135	0.931002168	0.906601648	0.87136844	0.893963064	0.962807086	0.378354621	0.960759497	0.288048644	0.602387367	0.501339347	0.814429641	0.975233564	0.706842349	0.968773536	0.885487431	0.846980318	0.887047614	0.999428343	0.293809857	0.998269684	0.976876957	0.66087119	0.971894882	0.885073915	0.859616376	0.876152635	1												
dev_distinct_rule_num_stat_std	0.45262154	0.451288023	0.692152059	-0.227270984	-0.389174724	0.072804067	0.233101401	0.631212926	0.219226013	0.09095337	0.159647848	0.050368904	0.394598493	0.964270439	0.315982779	0.249607095	0.701078719	0.261977181	0.090167349	0.222762682	0.049918063	0.385689004	0.982261963	0.317727295	0.69385169	-0.236202333	-0.347897791	0.00640969	0.206763229	0.555027859	0.198101276	0.050279803	0.076263659	0.041142685	0.338541297	0.987070681	0.287869536	0.216112435	0.648678043	0.216989859	0.047947069	0.13783529	0.025002832	0.3325147	1											
dev_distinct_rule_num_stat_median	0.425702633	0.425774095	0.253704393	0.65873246	0.535212384	0.801888037	0.946495584	0.619163184	0.929878288	0.915828042	0.864646912	0.911198173	0.953671033	0.297562882	0.963719604	0.941793315	0.582084825	0.924378297	0.916700037	0.876411738	0.90680768	0.956062937	0.332132256	0.959657655	0.247665797	0.609196531	0.515048201	0.815473641	0.974069369	0.680621166	0.968066695	0.894575473	0.852163845	0.897449771	0.996325494	0.245244399	0.998943079	0.975334072	0.637233866	0.970196952	0.894234158	0.866986153	0.886444792	0.998048686	0.286839704	1										
base_dev_ll_rec_mean_likelihood	-0.415515974	-0.416692041	0.570381326	-0.603375685	-0.648737288	-0.519159503	-0.439731462	0.017272976	-0.419178616	-0.737502002	-0.701760042	-0.75922148	-0.513425284	0.143899921	-0.549226182	-0.434070338	-0.008880613	-0.432400855	-0.739161553	-0.724048553	-0.760660011	-0.529641399	0.150357299	-0.584830112	0.562884775	-0.442319653	-0.485599273	-0.460663718	-0.457733718	-0.083529721	-0.454065152	-0.58419458	-0.551389719	-0.596613118	-0.498878528	0.160772096	-0.521566847	-0.457351896	-0.093543261	-0.464628239	-0.584817014	-0.582340803	-0.595067833	-0.511326991	0.156667073	-0.547252743	1									
base_dev_ll_rec_recall	0.18772786	0.188009671	-0.441410223	0.732463043	0.754300165	0.598775953	0.270603531	0.067212315	0.286899849	0.36184739	0.340137712	0.381345017	0.19496102	-0.275433758	0.19981098	0.237173464	-0.108527517	0.245471928	0.342405576	0.233890069	0.341787954	0.15809251	-0.353391526	0.176614647	-0.465977529	0.509691925	0.525397706	0.44528938	0.298327122	0.107239164	0.311949627	0.294882141	0.287450212	0.300826788	0.218617449	-0.305131893	0.225002074	0.284450967	-0.060542917	0.297013559	0.291832788	0.207461794	0.294085728	0.198328685	-0.37130278	0.211752347	-0.243098545	1								
full_dev_ll_rec_mean_likelihood	-0.427638374	-0.428725319	0.515020767	-0.563032827	-0.599691516	-0.498994923	-0.453084515	-0.014526827	-0.430930218	-0.740010966	-0.706300322	-0.75946941	-0.535191396	0.093096142	-0.568975995	-0.449755129	-0.05600432	-0.44728848	-0.743527871	-0.73760273	-0.763481331	-0.554151731	0.092141585	-0.60633868	0.504341325	-0.416932814	-0.45606604	-0.448607368	-0.469000248	-0.111583529	-0.464552693	-0.58909757	-0.55610782	-0.601209246	-0.519845766	0.106200492	-0.540941587	-0.469895818	-0.137910047	-0.476573609	-0.590009429	-0.595123179	-0.599120777	-0.533887911	0.094835871	-0.567770753	0.995390114	-0.165252517	1							
kl_stats_p1_coverage	0.444857847	0.444517512	0.214744183	0.48529956	0.347699982	0.681154289	0.852995074	0.554516689	0.832109525	0.817049424	0.772507197	0.806618144	0.907809371	0.468045108	0.898962907	0.863613934	0.57694574	0.866084026	0.822419396	0.806321526	0.813818328	0.919835772	0.493646791	0.910698111	0.207613411	0.461572468	0.357454062	0.655600693	0.81047391	0.580543673	0.80360446	0.690037708	0.658045502	0.690005697	0.850145738	0.407316135	0.841158981	0.819047312	0.588801733	0.822297611	0.690835674	0.672797533	0.685677954	0.855005224	0.430203425	0.847917853	-0.568898356	-0.014893633	-0.60201455	1						
kl_stats_p2_coverage	0.310889119	0.31045858	-0.162392375	0.691976896	0.649246524	0.672100791	0.426782206	0.262532525	0.461032178	0.416489565	0.407336485	0.418313624	0.351473687	-0.051170414	0.33491165	0.397826761	0.093674823	0.412926927	0.396967783	0.313448636	0.3827712	0.309084478	-0.115980758	0.30350156	-0.178966257	0.499183018	0.492324084	0.492137833	0.429217571	0.280426739	0.453261884	0.372955241	0.364567637	0.375560133	0.368632789	-0.062829729	0.361963372	0.418742164	0.140125632	0.434805701	0.370098143	0.303472011	0.36630429	0.347181497	-0.113281743	0.347988015	-0.136023204	0.897632144	-0.080248988	0.110931147	1					
kl_stats_union_coverage	0.478574894	0.478178062	0.179413981	0.598760344	0.458771565	0.781327153	0.90399486	0.584841176	0.889188398	0.866093746	0.820229771	0.857048192	0.940198676	0.434424614	0.92972687	0.90883357	0.574334089	0.913326719	0.867855361	0.834667238	0.857191302	0.944461446	0.448308742	0.935266693	0.169022479	0.544489605	0.441902183	0.728677209	0.86587065	0.614271569	0.863165536	0.73844399	0.705941342	0.738979598	0.890281498	0.372307624	0.881017216	0.87212043	0.594591262	0.877887321	0.738746278	0.707189498	0.733030749	0.8911246	0.386019271	0.884721594	-0.570697156	0.154794753	-0.591815077	0.983147752	0.2886543	1				
kl_stats_base_p_q	-0.342067158	-0.34432961	0.32157054	-0.54425506	-0.521105256	-0.417151418	-0.553662835	-0.149627831	-0.515245432	-0.735684634	-0.686924757	-0.74666475	-0.64616197	-0.100547863	-0.672997478	-0.55427746	-0.192169551	-0.547387903	-0.744665944	-0.695900764	-0.754662299	-0.667919609	-0.094981263	-0.707020416	0.321904906	-0.435005696	-0.430145111	-0.422983296	-0.531108651	-0.216237993	-0.518776983	-0.521799444	-0.500690578	-0.526909463	-0.572584916	-0.069646567	-0.582170282	-0.535209589	-0.239254272	-0.541305946	-0.524149173	-0.500996466	-0.52561582	-0.582893559	-0.069237823	-0.597634083	0.798000102	-0.051751183	0.818275626	-0.665654454	0.051653745	-0.6356538	1			
kl_stats_base_q_p	-0.37989085	-0.382074719	0.349662231	-0.629439202	-0.603697406	-0.50286545	-0.600792576	-0.181175156	-0.565834267	-0.792659899	-0.746472772	-0.803214561	-0.689696457	-0.098006704	-0.714209167	-0.598716378	-0.204892865	-0.593943956	-0.798649814	-0.747682978	-0.807530852	-0.706066812	-0.084594812	-0.744780689	0.353680652	-0.493295055	-0.486629802	-0.486445074	-0.580186648	-0.252813331	-0.570349858	-0.573326631	-0.552269488	-0.578612737	-0.616927359	-0.064937793	-0.625771676	-0.583175795	-0.25801718	-0.591089635	-0.575113158	-0.548017419	-0.576686669	-0.624559881	-0.057702365	-0.639833686	0.831634266	-0.158461403	0.843676343	-0.686505905	-0.059388571	-0.675585413	0.991480655	1		
kl_stats_smooth_p_q	-0.309411749	-0.311462325	0.279392415	-0.438215742	-0.421884519	-0.32268263	-0.478782675	-0.128771062	-0.430332698	-0.653239629	-0.611577594	-0.664425365	-0.572721672	-0.104790176	-0.596519886	-0.480563124	-0.201735775	-0.47143537	-0.665206474	-0.631166786	-0.67259775	-0.59901145	-0.114155686	-0.632783049	0.27588928	-0.370843512	-0.367642657	-0.358470662	-0.460515097	-0.187429663	-0.441889365	-0.45611696	-0.43855106	-0.46083308	-0.502487808	-0.075347663	-0.51127111	-0.46469852	-0.235222291	-0.468274663	-0.458917262	-0.442572171	-0.459868683	-0.514745263	-0.086664966	-0.527270831	0.735844855	0.041219139	0.762581588	-0.632070468	0.165876263	-0.583838712	0.981504068	0.957139437	1	
kl_stats_smooth_q_p	-0.462200177	-0.464364827	0.390573202	-0.753904285	-0.71790183	-0.623054684	-0.636265542	-0.221345928	-0.615348635	-0.830955452	-0.789718529	-0.838997407	-0.728311127	-0.12830709	-0.744760126	-0.628560394	-0.195307872	-0.628752347	-0.829393252	-0.768938587	-0.835070097	-0.730011752	-0.088515856	-0.766617639	0.402073672	-0.536898199	-0.52669257	-0.539597537	-0.613556163	-0.289999271	-0.611756375	-0.591969773	-0.572893512	-0.59694479	-0.651410903	-0.100240337	-0.655168935	-0.614622653	-0.255741314	-0.626038427	-0.592201778	-0.559741619	-0.592242264	-0.65174285	-0.070643725	-0.665333502	0.828233552	-0.372916113	0.823674349	-0.656757081	-0.303352166	-0.688974199	0.912936004	0.95440266	0.835230277	1
"""

def get_distance_matrix():
    data = [list(cell for cell in l.strip().split('\t')) for l in factor_distance_str.strip().split('\n')]
    factors = data[0]
    N = len(factors)

    distance = np.empty((N, N), dtype=np.float32)
    for i in range(N):
        for j in range(i + 1):
            corr = float(data[i + 1][j + 1])
            distance[i, j] = abs(corr - 1)
            distance[j, i] = abs(corr - 1)

    return factors, distance

def kmeans_from_distance_matrix(k: int, dist: np.ndarray, seed: int = 2021):
    assert dist.ndim == 2 and dist.shape[0] == dist.shape[1] and k < dist.shape[0]
    centroid_idx = _init_centroids(k, dist.shape[0], seed=seed)
    print("init:", centroid_idx)
    assignment = None

    for step in range(100):
        # assignment: (points,)
        assignment = _find_nearest_centroids(dist, centroid_idx)
        centroid_idx, min_dist = _find_new_centroids(k, dist, assignment)
        print(f"{step}: {centroid_idx}, {min_dist}, {min_dist.sum().item()}")

    return assignment.tolist()

def _init_centroids(k: int, N: int, seed=2021):
    rng = np.random.default_rng(seed=seed)
    factor_idx = np.arange(N)
    rng.shuffle(factor_idx)
    centroid_idx = factor_idx[:k]
    return centroid_idx

def _find_nearest_centroids(dist: np.ndarray, centroid_idx: np.ndarray) -> np.ndarray:
    dist_to_centroid: np.ndarray = dist[centroid_idx]
    return dist_to_centroid.argmax(axis=0)

def _find_new_centroids(k: int, dist: np.ndarray, assignments: np.ndarray):
    """
    :param dist: (N, N)
    :param assignments:  (N,)
    :return:
    """
    N = dist.shape[0]

    # select corresponding distance value from the total dist matrix
    group_mask = np.eye(k, dtype=int)[assignments].T  # (K, N)
    group_division = np.expand_dims(np.arange(N), 0) * group_mask
    group_dist = dist[group_division]   # (K, N, N)

    # sum over only the distances within the same group
    group_dis_sum = (group_dist * np.expand_dims(group_mask, -1)).sum(-1) # (K, N)

    # find and return the index to the elements
    # whose sum-distance is the smallest, i.e., the cost to connect other items are the cheapest
    group_dis_sum[group_mask == 0] = np.inf
    return group_dis_sum.argmin(-1), group_dis_sum.min(-1)

def main():
    factor, distance = get_distance_matrix()
    assignment = kmeans_from_distance_matrix(3, distance, seed=2021)
    clusters = {}
    for f, a in zip(factor, assignment):
        print(f"{f}: {a}")
        if a not in clusters:
            clusters[a] = []
        clusters[a].append(f)

    for k, v in clusters.items():
        print(f"{k}: " + '\n'.join(v))

if __name__ == '__main__':
    main()
